<!--
       _                   _ _          ______    _
      | |                 (_) |        |  ____|  | |
      | |_   _  __ _ _ __  _| |_ ___   | |__ __ _| |_ __ _ ___
  _   | | | | |/ _` | '_ \| | __/ _ \  |  __/ _` | __/ _` / __|
 | |__| | |_| | (_| | | | | | || (_) | | | | (_| | || (_| \__ \
  \____/ \__,_|\__,_|_| |_|_|\__\___/  |_|  \__,_|\__\__,_|___/
-->
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>測試！測試！ - 002 | I'm Juanito Fatas</title>
  <meta name="author" content="Juanito Fatas">
  
  <meta name="description" content="This site contains technical articles, presentations, thoughts, software, and other materials by Juanito Fatas.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="測試！測試！ - 002"/>
  <meta property="og:site_name" content="I'm Juanito Fatas"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="I'm Juanito Fatas" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
    <link rel="stylesheet" type="text/css" href="//cdn.moot.it/1/moot.css">
  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script>
  $(document).ready(function() {
    $('#sidebar').delay(400).animate({ width: '285px' }, 500, function() {
      $('.personal-info').css({display: 'table'}).hide().fadeIn(500);
    });
  });
  </script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41041908-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><!-- <div class="alignleft">
  <h1><a href="/">I'm Juanito Fatas</a></h1>
  <h2><a href="/">C-x C-f...C-x C-s...</a></h2>
</div>
 --><!-- <nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首頁</a></li>
    
      <li><a href="/archives">彙整</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
 --></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignright"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2012-04-25T02:51:00.000Z"><a href="/2012/04/25/ror-2-test-unit/">Apr 25 2012</a></time>
      
      
  
    <h1 class="depth title">測試！測試！ - 002</h1>
  

    </header>
    <div class="entry depth">
      
        <p><strong>1000 个小时学会 Rails 系列</strong></p>
<blockquote>
<p>The general idea behind unit testing is that you write a test method that makes certain assertions about your code, working against a test fixture. A bunch of these test methods are bundled up into a test suite and can be run any time the developer wants. The results of a run are gathered in a test result and displayed to the user through some UI.
-- Nathaniel Talbott</p>
</blockquote>
<p>好了，Rails 真的很牛。Ruby 是如此优雅精妙，那么程序员真的性福美满了吗？那究竟要如何写出可维护的代码呢？拜读松本行弘的程序世界？不是！连读七遍 Programming Ruby 1.9？有可能！每天上 Ruby-china 学习？这就对了！好了那到底是什么？答案是写测试！</p>
<p>型別</p>
<p>为什么要写测试呢？恩，先谈谈两种程序员吧。一种是自负的程序员，他们觉得：“日出东方，唯我代码不坏”，这种思想其实很好，是社会进步的动力之一。这种人要嘛特别牛，要嘛特别。。。0010，但我们要看清一个事实，是人都会犯错。另一种程序员，怎么著都怕出错，在论坛四处发问，哪本书最好，哪个教程最猛，写程序战战兢兢，就跟相亲挑老婆，结果如墨菲先生预言：只要有可能出错，那就一定会出错。第一种程序员，根本不屑写测试，第二种程序员，拼命学写测试，学的连代码都不会写了。该怎么办？</p>
<p>还是写测试！在编码前先写测试，这有什么好处？预测程序的行为、确保程序如你想的那般工作、有写测试让你更有自信，更容易重构代码，理清你的思路，等等好处。那为什么大家都不写测试呢？呃。。。很多原因是老板太凶、日期太紧，但我相信测试可以救你于水火之中。而 Rails 也替你打点了许多的测试工具，让你不用在「编码 -&gt; 储存 -&gt; 刷新 -&gt; 编码 -&gt; 储存 -&gt; 刷新...」、要是一个个视图、一个个模型、一个个控制器都是如此手工测试，搞得你晚上八点还在公司，一出错又不知从何查起，真是一场永远不会醒的恶梦。测试可以使我们确保程序正常运作，将用户行为转为测试，让我们有一个开发的方向。未来出错时，可以改动现有的测试来适应新的情况，让你可以早日回家陪老婆孩子（家庭第一），正所谓，测试写得好，挣钱挣到老，测试写的巧，上班没烦恼。</p>
<p>月有阴晴圆缺，而生命会自己找到出口，就这样，有了<a href="http://zh.wikipedia.org/wiki/%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91">测试驱动开发</a>（Test-Driven Development, TDD）以及<a href="http://zh.wikipedia.org/wiki/%E8%A1%8C%E4%B8%BA%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91">行为驱动开发</a>（Behavior-Driven Development, BDD）。TDD 又有一个名字叫做 Red-Green-Refactor。先写好测试，运行，错误一堆（满江红），撰写可以通过测试的代码（绿油油），测试通过后再重构，确保代码仍然工作。这样子的好处是？一来先写测试可以先让你想想程序的思路，与下棋有异曲同功之妙，只不过下棋咱是在脑里演练；二来写测试可以确保你的程序正常工作，预期未来可能发生的错误。然而我们从小的教育不是这样，导致我们害怕犯错，以前可以考试先考差了，再让你重写一次考卷嘛？现在机会来了。写测试吧！</p>
<p>恩，至于这 BDD 与 TDD 精确的定义呢，危机、摆渡百科都有，谷歌百度一下吧，就不赘述了，用了就知道！BDD 是基于 TDD 所造出来的，旨在测试整个程序中，各个“正常工作代码”之间的互动。也就是说呢，TDD 搭配 BDD 使用。TDD 的工具我们将粗浅介绍 Test::Unit，BDD 我们将介绍的是 RSpec 搭配 海豚 (Capybara)，小黄瓜 (Cucumber) 就别用了，太坑爹了，还是留著配炸酱面吧！</p>
<p>还是不怎么信么？那我再好好讲一次测试的好处，你想想，如果你要测试某个页面的表单，填了某个值会发生什么事，要是这个表单一共有九种变化，共有九种不同表单，九九八十一个变化，还不算你手滑按错的错误，这测起来真是想死的心都有了（爱惜生命！）。让计算机自动帮我们测试，比起手工测试好、省时又省心。另一个好处是，测试可以预防你犯傻。当你犯了一个再明显不过的错误时，测试可以替你找出来，替你的程序做一个健康检查，让你获得更多信息，由测试通知你，总比暴跳如雷的老板来得好。用户永远都有无止尽的好奇心，会在你想都想不到的地方，把东西弄坏！有了之前的测试，你可以轻松的改写之前的测试，来满足这个你未预期的情况，这又叫作<a href="http://zh.wikipedia.org/wiki/%E5%9B%9E%E5%BD%92%E6%B5%8B%E8%AF%95">回归测试</a> (Regression Test)</p>
<p>现在我们来看怎么用 Test::Unit 写测试吧！</p>
<h3>撰写第一个测试</h3>
<p>Ruby 的 <code>Test::Unit</code> 写了一堆的函式库，就在哪里，等著、盼著、寂寞地等你调用它们。接下来我来讲一个简单的 <code>Test::Unit</code> 例子。首先建立一个目录，叫作 <code>example</code> ，在这个目录里你创一个文件：<code>example_test.rb</code> 。记得把测试加上 <code>_test</code> 的字尾，这样子一看就知道这是一个测试文件。打开这个 <code>example_test.rb</code> ，敲入以下代码：</p>
<pre><code>require <span class="string">'test/unit'</span>

<span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> &lt; <span class="title">Test</span>::<span class="title">Unit</span>::<span class="title">TestCase</span>
  <span class="title">def</span> <span class="title">test_truth</span>
    <span class="title">assert</span> <span class="title">true</span>
  <span class="title">end</span>
<span class="title">end</span>
</code></pre>
<p><code>Test::Unit</code> 测试呢，首先引入 Ruby 标准函式库的 <code>&#39;test/unit&#39;</code> 。这让你可以从 <code>Test::Unit::TestCase</code> 继承它所有的东西（要是可以 <code>require &#39; 李嘉诚 &#39;</code> 就好了，我也不用。。。）。那究竟继承了什么？继承了让你可以在类里面，将名字取为 <code>test_</code> 打头的方法来写测试的功能，<code>test_xxxx</code> 会被识别成是测试。</p>
<p>第一个测试写好了！！！！！！！（咆哮体），让我们来运行看看： </p>
<p><code>ruby example_test.rb</code> </p>
<p>你会看到像是这样的输出：</p>
<pre><code>.

Finished tests <span class="keyword">in</span> <span class="number">0.000866</span>s, <span class="number">1154.7344</span> tests<span class="regexp">/s, 1154.7344 assertions/</span>s.

<span class="number">1</span> tests, <span class="number">1</span> assertions, <span class="number">0</span> failures, <span class="number">0</span> errors, <span class="number">0</span> skips
</code></pre>
<p>那个奇怪的点是什么呢？这是 <code>Test::Unit</code> 告诉你一个测试成功通过的方式， <code>F</code> 代表不通过的测试, <code>E</code> 代表有错误的测试，那 <code>(.)(.)</code> 呢？哈哈开个玩笑，确保你有认真看。跟著点之后是一些统计数据，告诉你一个测试、一个断言 (assertion)、零个失败、零个错误、零个跳过。</p>
<p>在你的测试中你用了一个 <code>assert</code> 方法，你断言传入的参数为真。然而我们传入的是真（非 <code>nil</code> 与 <code>false</code> 亦为真），假如不知为何的这个方法失败了，会引起一个 exception 告诉你。 </p>
<p>如果你的方法名不是 <code>test_</code> 打头：</p>
<pre><code>test <span class="string">"truth"</span> <span class="keyword">do</span>
    <span class="built_in">assert</span> <span class="keyword">true</span>
<span class="keyword">end</span>
</code></pre>
<p>你再运行看看 (<code>ruby example_test.rb</code>)，会发现</p>
<pre><code><span class="title">No</span> tests were specified.
<span class="number">1</span> tests, <span class="number">1</span> assertions, <span class="number">1</span> failures, <span class="number">0</span> errors
</code></pre>
<p>这是因为 <code>Test::Unit</code> 调用了缺省的 <code>default_test</code> 缘故，若你使用的是 1.9.3+ 的 Ruby 只会显示没有测试。</p>
<p>所以记得把测试方法名用 <code>test_</code> 开头！</p>
<p>接下来让我们考虑一个更复杂的方法，建立一个 <code>love_test.rb</code> ：</p>
<pre><code>require <span class="string">'test/unit'</span>
<span class="class"><span class="keyword">class</span> <span class="title">LoveTest</span> &lt; <span class="title">Test</span>::<span class="title">Unit</span>::<span class="title">TestCase</span>
  <span class="title">def</span> <span class="title">test_saved</span>
    <span class="title">assert</span> <span class="title">Love</span>.<span class="title">saved</span>?
  <span class="title">end</span>
<span class="title">end</span>
</code></pre>
<p>当然了，你想确保你的愛情有保存，但是当你运行时 <code>ruby love_test.rb</code> ，哎呀：</p>
<pre><code><span class="attribute">NameError</span>: <span class="string">uninitialized constant LoveTest::Love</span>
</code></pre>
<p>哪知道你根本还没有愛情，让我们来定义爱情：</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">Love</span>

<span class="title">end</span>
</code></pre>
<p>那这个愛情要放在测试之前呢，还是测试之后呢？在 <code>Test::Unit</code> 里是都可以，在 Ruby 里面东西都是得先定义才能使用，但是 <code>Test::Unit</code> 会先把所有的代码求值，再来运行测试，所以现在 <code>love_test.rb</code> ：</p>
<pre><code>require <span class="string">'test/unit'</span>

<span class="class"><span class="keyword">class</span> <span class="title">Love</span>

<span class="title">end</span>

<span class="title">class</span> <span class="title">LoveTest</span> &lt; <span class="title">Test</span>::<span class="title">Unit</span>::<span class="title">TestCase</span>
  <span class="title">def</span> <span class="title">test_saved</span>
    <span class="title">assert</span> <span class="title">Love</span>.<span class="title">saved</span>?
  <span class="title">end</span>
<span class="title">end</span>
</code></pre>
<p>接下来再运行看看 <code>ruby love_test.rb</code> ：</p>
<pre><code><span class="attribute">NoMethodError</span>: <span class="string">undefined method `saved?' for Love:Class</span>
</code></pre>
<p>错误信息明确的告诉我们，愛情是不能保质的，看来 Ruby 也挺懂人情事理的，但我們可以自己定義一個保存的方法：</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">Love</span></span>
    <span class="function"><span class="keyword">def</span> <span class="title"><span class="keyword">self</span></span>.<span class="title">saved?</span></span>
      <span class="keyword">true</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</code></pre>
<p>接著运行你会如预期的发现测试通过，但是有一天，就是風雨交加的那天，不知为何某女把你的测试改成 <code>false</code> ：</p>
<pre><code>F

Finished tests <span class="keyword">in</span> <span class="number">0.001137</span>s, <span class="number">879.5075</span> tests<span class="regexp">/s, 879.5075 assertions/</span>s.

  <span class="number">1</span>) Failure:
test_saved(LoveTest) [love_test.rb:<span class="number">14</span>]:
Failed assertion, <span class="literal">no</span> message given.
</code></pre>
<p>失败，最惨的是 <code>no message given</code> 。。。</p>
<p>居然什么信息也不给，唉，其实这是 <code>Test::Unit</code> 一贯回报测试失败的方式，</p>
<p>然而某女突然觉得过意不去，又回头给你加上一个更清楚的信息：</p>
<pre><code>  <span class="comment">assert</span> <span class="comment">Love</span>.<span class="comment">saved?</span>, <span class="comment">"咱俩不合适！</span> <span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="comment">"</span> 
</code></pre>
<p>现在你再运行测试，你会得到一个清楚的错误信息</p>
<pre><code>  1) <span class="tag">Failure</span>:
<span class="tag">test_saved</span>(<span class="tag">LoveTest</span>) <span class="attr_selector">[love_test.rb:16]</span>:
咱俩不合适！
</code></pre>
<p>嗯，你懂得，我的朋友。。。。。他说风雨中这点痛算什么，擦乾泪不要问，至少我们还有梦！</p>
<p>这就是使用 <code>Test::Unit</code> 非非非非非非常基本的 TDD 了， <code>Test::Unit</code> 是 Rails 缺省的测试框架，在我们漫长的学习 Rails 的旅途中，你将会常常看到它，并且克制不住的或是被逼迫的使用它。</p>
<p>记得哦，爱情是没有保质期的，亲。</p>
<p>距离学会 Rails 还有 965 个小时。。。</p>
<p>待续。。。</p>
<h3>延伸阅读</h3>
<p><a href="http://courseware.codeschool.com.s3.amazonaws.com/rails_testing.pdf">CodeSchool: Rails Testing for Zombies slides</a></p>
<p><a href="http://guides.rubyonrails.org/testing.html">A Guide to Testing Rails Applications</a></p>
<p><a href="http://ihower.tw/rails3/testing.html">测试 Testing</a></p>
<p><a href="http://rubykoans.com/">Ruby Koans</a></p>
<p><a href="http://ruby-china.org/search?q=Test%3A%3AUnit">Ruby-china 上关于测试的帖子</a></p>
<p><a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/test/unit/rdoc/Test/Unit.html">Ruby Test::Unit 函式库</a></p>
<p><a href="http://www.google.com.hk/webhp?hl=zh-CN&amp;sourceid=cnhp#hl=zh-CN&amp;safe=strict&amp;site=webhp&amp;source=hp&amp;q=%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A5%B3%E6%9C%8B%E5%8F%8B%E4%B8%8D%E8%A6%81%E6%88%91%E4%BA%86&amp;oq=%E4%B8%BA%E4%BB%80%E4%B9%88%E5%A5%B3%E6%9C%8B%E5%8F%8B%E4%B8%8D%E8%A6%81%E6%88%91%E4%BA%86&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_nf=1&amp;gs_l=hp.3...1405.6419.0.6789.34.32.1.0.0.0.105.1818.30j1.31.0.uZEfYhm1ZUM&amp;bav=on.2,or.r_gc.r_pw.,cf.osb&amp;fp=4de69b13c14b576b">为什么女朋友不要我了</a></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Rails/">Rails</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Rails/">Rails</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div></div>
    <aside id="sidebar" class="alignleft"><!-- 
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:lisp.es/">
  </form>
</div>

  
<div class="widget twitter">
  <h3 class="title">推文</h3>
  <ul id="tweets"></ul>
</div>

<script type="text/javascript">
var twitter_stream = ['JuanitoFatas', 5, false];
var moment_js_path = '/js/moment.min.js';
</script>
<script src="/js/twitter.js"></script>


 -->
<div class="personal-info">
  <figure>
    
      <a href="/">
        <img class="personal-photo" src="https://secure.gravatar.com/avatar/771951f55ed37335f238e1a80dfda9cd?s=420&d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png" alt="Juanito Fatas">
      </a>
    
    <figcaption>
      <h3 class=>Juanito Fatas</h3>
      <p>城市中的迷途小碼農</p>
    </figcaption>
  </figure>
  <section class="social">
    
      <a target="_blank" class="icon twitter depth" href="http://twitter.com/JuanitoFatas"></a>
    
    
    
      <a target="_blank" class="icon github depth" href="http://github.com/JuanitoFatas"></a>
    
    
      <a target="_blank" class="icon email depth" href="mailto:katehuang0320@gmail.com"></a>
    
  </section>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignright depth">
  <a class="footer-link" href="/about">About Me</a>
  <a class="footer-link" href="http://github.com/thiagopnts/hexo-persona-dark">Based on Persona Dark Theme</a> 
  &copy; - 2013 Juanito Fatas
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'juanfatas';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



<script src="//cdn.moot.it/latest/moot.min.js"></script>

</body>
</html>