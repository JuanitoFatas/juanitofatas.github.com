<!--
       _                   _ _          ______    _
      | |                 (_) |        |  ____|  | |
      | |_   _  __ _ _ __  _| |_ ___   | |__ __ _| |_ __ _ ___
  _   | | | | |/ _` | '_ \| | __/ _ \  |  __/ _` | __/ _` / __|
 | |__| | |_| | (_| | | | | | || (_) | | | | (_| | || (_| \__ \
  \____/ \__,_|\__,_|_| |_|_|\__\___/  |_|  \__,_|\__\__,_|___/
-->
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>「轉」解剖 RequireJS | I'm Juanito Fatas</title>
  <meta name="author" content="Juanito Fatas">
  
  <meta name="description" content="This site contains technical articles, presentations, thoughts, software, and other materials by Juanito Fatas.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="「轉」解剖 RequireJS"/>
  <meta property="og:site_name" content="I'm Juanito Fatas"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="I'm Juanito Fatas" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
    <link rel="stylesheet" type="text/css" href="//cdn.moot.it/1/moot.css">
  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script>
  $(document).ready(function() {
    $('#sidebar').delay(400).animate({ width: '285px' }, 500, function() {
      $('.personal-info').css({display: 'table'}).hide().fadeIn(500);
    });
  });
  </script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41041908-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>


<body>
  <header id="header" class="inner"><!-- <div class="alignleft">
  <h1><a href="/">I'm Juanito Fatas</a></h1>
  <h2><a href="/">C-x C-f...C-x C-s...</a></h2>
</div>
 --><!-- <nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首頁</a></li>
    
      <li><a href="/archives">彙整</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
 --></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignright"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon depth"></div>
        <time class="depth" datetime="2013-07-19T08:19:17.000Z"><a href="/2013/07/19/anatomy-of-require-js/">Jul 19 2013</a></time>
      
      
  
    <h1 class="depth title">「轉」解剖 RequireJS</h1>
  

    </header>
    <div class="entry depth">
      
        <h2>定義模組</h2>
<p>RequireJS 也實作 AMD 所定義的 <code>define</code> API 方法，所以我們就可以用它來實現程式的模組化。
<code>define</code> 的 API 如下：</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>define(id?, dependencies?, factory);
</pre></td></tr></table></figure>

<h3>參數說明：</h3>
<p><code>id</code>：可選的模組名稱，相對於目前的檔案路徑。
<code>dependencies</code>：作用與 <code>require</code> 的 <code>dependencies</code>相同。
<code>factory</code>：一個工廠方法，它必須回傳一個物件。</p>
<h3>範例：</h3>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>define(<span class="string">"lib/a"</span>, <span class="keyword">function</span>(){
    <span class="keyword">return</span>{
        doSomething: <span class="keyword">function</span>(){
            <span class="comment">// doSomething</span>
        }
    };
});
</pre></td></tr></table></figure>

<h2>引入模組</h2>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>require(<span class="string">'ModuleName'</span>, dependencies, callback);
</pre></td></tr></table></figure>

<h3>參數說明：</h3>
<p><code>ModuleName</code>：一個可選的參數名。
<code>dependencies</code>： 模組路徑用數組 <code>[]</code> 方式引入，不用模組間用<code>,</code>隔開。
<code>callback</code>：當模組完成載入後，執行回呼函數。</p>
<h3>範例</h3>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>require([<span class="string">'lib/a'</span>], <span class="keyword">function</span>(moduleA){
    moduleA.doSomething();
});
</pre></td></tr></table></figure>

<h2>順序問題</h2>
<p>因為使用非同步的載入方式，所以用 <code>require</code> 載入套件時，是有可能會造成相依性上的問題。 所幸 RequireJS 提供了一個 <code>order plugin</code> ，讓我們可以依序載入正確的套件。
(未完成)</p>
<h2>RequireJS 與第三方套件</h2>
<p>其實可以看到我們是直接利用該套件定義好的 namespace ，例如 jQuery 的 <code>$</code> 符號，或是 underscore.js 的 <code>_</code> 符號。</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>require([<span class="string">'lib/jquery'</span>, <span class="string">'libs/underscore'</span>, <span class="string">'libs/backbone'</span>], <span class="keyword">function</span>(){
    console.log($); <span class="comment">// work</span>
    console.log(_); <span class="comment">// work</span>
    console.log(Backbone); <span class="comment">//work</span>
});
</pre></td></tr></table></figure>

<p>我們並沒有再為這些套件指定新的 namespace ，是因為這些 namespace 已經被綁在 <code>global</code> 變數裡了。
再看一個例子，若我們將套件的別名傳進函數裡</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>require([<span class="string">'lib/jquery'</span>, <span class="string">'libs/underscore'</span>, <span class="string">'libs/backbone'</span>], <span class="keyword">function</span>($, _, Backbone){
    console.log($); <span class="comment">// work</span>
    console.log(_); <span class="comment">// work</span>
    console.log(Backbone); <span class="comment">//undefined</span>
});
</pre></td></tr></table></figure>
會發現傳進函數裡的參數都變成 <code>undefined</code>，所以很多人在透過 RequireJS 使用這些套件時，就會在這裡卡關。
為什麼呢？主要是因為這 jQuery、Underscore 這兩個套件已支援 AMD 架構。

<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="comment">// Expose jQuery as an AMD module, but only for AMD loaders that</span>
<span class="comment">// understand the issues with loading multiple versions of jQuery</span>
<span class="comment">// in a page that all might call define(). The loader will indicate</span>
<span class="comment">// they have special allowances for multiple jQuery versions by</span>
<span class="comment">// specifying define.amd.jQuery = true. Register as a named module,</span>
<span class="comment">// since jQuery can be concatenated with other files that may use define,</span>
<span class="comment">// but not use a proper concatenation script that understands anonymous</span>
<span class="comment">// AMD modules. A named AMD is safest and most robust way to register.</span>
<span class="comment">// Lowercase jquery is used because AMD module names are derived from</span>
<span class="comment">// file names, and jQuery is normally delivered in a lowercase file name.</span>
<span class="comment">// Do this after creating the global so that if an AMD module wants to call</span>
<span class="comment">// noConflict to hide this version of jQuery, it will work.</span>
<span class="keyword">if</span> ( <span class="keyword">typeof</span> define === <span class="string">"function"</span> && define.amd && define.amd.jQuery ) {
    define( <span class="string">"jquery"</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> jQuery; } );
}
</pre></td></tr></table></figure>
當 <code>define</code> 這個函式已經定義時， jQuery 把自已輸出成一個命名模組。
Underscore 也做了類似的事，但是 Backbone 並不支援 AMD 架構。

### 坑爹的地方

照理說，只要支援了 AMD 架構的套件，應該就能像上例一樣，將別名傳入參數就行了

<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre>require([<span class="string">'lib/jquery'</span>, <span class="string">'libs/underscore'</span>, <span class="string">'libs/backbone'</span>], <span class="keyword">function</span>($, _){
    console.log($); <span class="comment">// undefined</span>
    console.log(_); <span class="comment">// undefined</span>
});
</pre></td></tr></table></figure>

<p>但卻還是 <code>undefined</code>！！？這就是坑爹的地方！！
原因是 jQuery 和 Underscore 預設的載入位置是與當前檔案同目錄</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>define( <span class="string">"jquery"</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> jQuery; } );
</pre></td></tr></table></figure>

<h3>解決辦法</h3>
<ul>
<li>將 main.js 和 jquery.js 放在同一個目錄底下。</li>
<li>修改 jquery.js 的程式碼，將 <code>define</code> 裡的名稱修改成 jquery.js 的目錄。</li>
</ul>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="keyword">if</span> ( <span class="keyword">typeof</span> define === <span class="string">"function"</span> && define.amd && define.amd.jQuery ) {
    define( <span class="string">"libs/jquery"</span>, [], <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> jQuery; } );
}
</pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div></div>
    <aside id="sidebar" class="alignleft"><!-- 
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:lisp.es/">
  </form>
</div>

  
<div class="widget twitter">
  <h3 class="title">推文</h3>
  <ul id="tweets"></ul>
</div>

<script type="text/javascript">
var twitter_stream = ['JuanitoFatas', 5, false];
var moment_js_path = '/js/moment.min.js';
</script>
<script src="/js/twitter.js"></script>


 -->
<div class="personal-info">
  <figure>
    
      <a href="/">
        <img class="personal-photo" src="https://secure.gravatar.com/avatar/771951f55ed37335f238e1a80dfda9cd?s=420&d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png" alt="Juanito Fatas">
      </a>
    
    <figcaption>
      <h3 class=>Juanito Fatas</h3>
      <p>城市中的迷途小碼農</p>
    </figcaption>
  </figure>
  <section class="social">
    
      <a target="_blank" class="icon twitter depth" href="http://twitter.com/JuanitoFatas"></a>
    
    
    
      <a target="_blank" class="icon github depth" href="http://github.com/JuanitoFatas"></a>
    
    
      <a target="_blank" class="icon email depth" href="mailto:katehuang0320@gmail.com"></a>
    
  </section>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignright depth">
  <a class="footer-link" href="/about">About Me</a>
  <a class="footer-link" href="http://github.com/thiagopnts/hexo-persona-dark">Based on Persona Dark Theme</a> 
  &copy; - 2013 Juanito Fatas
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'juanfatas';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



<script src="//cdn.moot.it/latest/moot.min.js"></script>

</body>
</html>